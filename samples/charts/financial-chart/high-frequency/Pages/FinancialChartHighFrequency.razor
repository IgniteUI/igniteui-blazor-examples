@page "/FinancialChartHighFrequency"
@* this namespace is required for Infragistics controls *@
@using Infragistics.Blazor.Controls
@using Samples.Services
@inject IInfragisticsBlazor InfragisticsBlazor;
@inject IJSRuntime JSRuntime;

<div class="igContainer">
    <div class="igOptions">
        <label className="igOptions-label">Refresh Interval:</label>
        <label className="igOptions-value">@RefreshInfo</label>
        <input className="igOptions-slider" type="range" min="5" max="1000"
               value=@RefreshInterval
               @onchange=OnRefreshFrequencyChanged />
        <label className="igOptions-label">Data Points:</label>
        <label className="igOptions-value">@DataPoints</label>
        <input className="igOptions-slider" type="range" min="250" max="100000" step="1000"
               value=@DataPoints
               @onchange=OnDataPointsChanged />
        <button className="igOptions-button" @onclick="OnDataGenerateClick">Generate Data</button>
        <label className="igOptions-label">Optimize Scaling: </label>
        <input type="checkbox" @onchange="OnOptimizeScalingChanged" />
        <label className="igOptions-label">FPS: @FPS</label>
    </div>

    <div class="igComponent">

        @if (DataSource != null)
        {
            <FinancialChart Width="100%" @ref="Chart"
                Height="100%"
                ChartType=FinancialChartType.Line
                Thickness=2                           
                DataSource="DataSource"
                PixelScalingRatio="ScalingRatio"
                ZoomSliderType="FinancialChartZoomSliderType.None"/>
        }
    </div>
</div>

@code {

    private System.Collections.ObjectModel.ObservableCollection<StockItem> DataSource;
    private FinancialChart Chart;
    private double DataPoints { get; set; } = 1000;
    private int DataIndex { get; set; } = 0;
    private string DataInfo { get; set; }
    private double ScalingRatio { get; set; } = 1;
    private int RefreshInterval { get; set; } = 10;
    private double RefreshMilliseconds = 10;
    private string RefreshInfo { get; set; }
    private int FPS { get; set; } = 1;
    public int _frameCount;
    public DateTime _time;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        FinancialChartModule.Register(InfragisticsBlazor);

        var dataList = StocksUtility.GetStocksItems((int)this.DataPoints);
        this.DataSource = new System.Collections.ObjectModel.ObservableCollection<StockItem>(dataList);
        this.DataIndex = this.DataSource.Count;
        this.DataInfo = StocksUtility.toShortString(this.DataPoints);
        this.RefreshInfo = (this.RefreshMilliseconds / 1000).ToString() + "s";
        this.SetupInterval();
    }

    private void OnOptimizeScalingChanged(ChangeEventArgs e)
    {
        if ((bool)e.Value == true)
        {
            this.ScalingRatio = 1.0;
        }
        else
        {
            this.ScalingRatio = 0;
        }
    }

    private void OnDataGenerateClick()
    {
        var dataList = StocksUtility.GetStocksItems((int)this.DataPoints);

        this.DataSource = new System.Collections.ObjectModel.ObservableCollection<StockItem>(dataList);
        this.DataIndex = this.DataSource.Count;
        SetupInterval();
    }

    private void OnRefreshFrequencyChanged(ChangeEventArgs e)
    {
        double num = double.Parse(e.Value.ToString());

        if (num < 10) {
            num = 10;
        }
        if (num > 500) {
            num = 500;
        }
        this.RefreshMilliseconds = num;
        this.RefreshInfo = (this.RefreshMilliseconds / 1000).ToString() + "s";

        if (this.DataSource.Count > 0)
        {
            this.SetupInterval();
        }

    }

    private void OnDataPointsChanged(ChangeEventArgs e)
    {
        double num = double.Parse(e.Value.ToString());
        num = 10;

        if (num < 250)
        {
            num = 250;
        }
        if (num > 1000000)
        {
            num = 1000000;
        }

        string info = StocksUtility.toShortString(num);
        this.DataPoints = num;
        this.DataInfo = info;

    }

    private void SetupInterval()
    {
        Task.Delay((int)this.RefreshMilliseconds).ContinueWith((t) => OnTimerTick());
    }

    private void OnTimerTick()
    {
        this.DataIndex++;
        var oldItem = this.DataSource[0];
        var newItem = StocksUtility.GetNewItem(this.DataSource.ToList(), this.DataIndex);
        this.DataSource.Add(newItem.FirstOrDefault());
        this.Chart.NotifyInsertItem(this.DataSource, this.DataSource.Count - 1, newItem);
        this.DataSource.RemoveAt(0);
        this.Chart.NotifyRemoveItem(this.DataSource, 0, oldItem);

        this._frameCount++;
        var currTime = DateTime.Now;
        var elapsed = (currTime.TimeOfDay - this._time.TimeOfDay);
        if (elapsed.Ticks > 5000)
        {
            var fps = this._frameCount / (elapsed.Ticks / 1000.0);
            this._time = currTime;
            this._frameCount = 0;
            this.FPS = (int)Math.Round(fps);
        }

        Task.Delay((int)this.RefreshMilliseconds).ContinueWith((t) => OnTimerTick());
        this.StateHasChanged();
    }
}